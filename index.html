<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<title>Asistente Diario PRO - Versi√≥n Unificada (Cloud + Funciones Avanzadas)</title>
<style>
    /* Dise√±o Base */
    body { 
        font-family: Arial, sans-serif; 
        margin: 20px auto; 
        background: #f4f4f4; 
        max-width: 1200px; 
        padding: 0 20px; 
    }
    
    h1 { color: #333; }
    .section { margin-bottom: 30px; background: #fff; padding: 20px; border-radius: 8px; }
    input, textarea, select { margin: 5px 0; padding: 8px; width: 100%; border: 1px solid #ccc; border-radius: 4px; }
    
    /* === ESTILOS PARA EL ENCABEZADO Y BOT√ìN SALIR === */
    .header-container {
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        margin-bottom: 10px; 
    }
    .logout-btn {
        background: #d32f2f; /* Rojo para el bot√≥n de salir */
        font-weight: bold;
        padding: 8px 12px;
    }
    .logout-btn:hover {
        opacity: 0.8;
    }
    /* ======================================================= */

    /* Estilo para el bot√≥n de Google (Login) */
    .google-btn { 
        padding: 10px 15px; 
        margin: 5px 5px 0 0; 
        border: none; 
        border-radius: 5px; 
        cursor: pointer; 
        background: #db4437; /* Rojo de Google */
        color: white; 
        font-weight: bold;
    }
    .google-btn:hover { opacity: 0.9; }
    
    /* Estilo para los botones generales */
    button { padding: 10px 15px; margin: 5px 5px 0 0; border: none; border-radius: 5px; cursor: pointer; background: #1976d2; color: white; }
    button:hover { opacity: 0.9; }
    
    /* MODIFICACI√ìN CLAVE: REGLAS PARA EL SCROLL EN LA LISTA UL */
    ul { 
        list-style-type: none; 
        padding: 0; 
        max-height: 400px; /* Altura m√°xima de la lista */
        overflow-y: auto;  /* Habilita el scroll vertical */
        border: 1px solid #ccc; /* Borde para delimitar el √°rea con scroll */
        padding-right: 10px; /* Espacio para el scroll */
    }

    li { 
        margin: 5px 0; 
        padding: 10px; /* Aumentado padding para mejor toque en m√≥vil */
        background: #eaeaea; 
        border-radius: 5px; 
        cursor: pointer; 
        white-space: normal;
        transition: background-color 0.3s, box-shadow 0.3s;
    }
    .completed { 
        text-decoration: line-through; 
        color: gray; 
        background: #f1f1f1; 
    }
    .calendar { display: grid; grid-template-columns: repeat(5, 1fr); gap: 5px; } 
    .day { background: #ddd; padding: 10px; border-radius: 5px; min-height: 60px; }
    
    .current-day {
        background-color: #b0b0b0 !important;
        border: 2px solid #555;
    }
    
    .stats { font-weight: bold; margin-top: 10px; }
    
    .task-buttons { 
        display: flex; 
        gap: 10px; 
        flex-wrap: wrap; 
        margin-top: 10px; 
        align-items: flex-start;
        justify-content: space-between; 
    }
    
    .urgent-tag {
        color: red;
        font-weight: bold;
    }

    /* Estilos para Etiqueta y Fecha lado a lado*/
    .task-inputs-row {
        display: flex; 
        gap: 10px;    
        margin: 5px 0 10px 0; 
    }

    .task-inputs-row select,
    .task-inputs-row input[type="date"] {
        width: 50%; 
        margin: 0;  
    }

    /* ESTILOS DEL BANNER DE ALERTA */
    .alert-banner {
        padding: 15px;
        margin-bottom: 20px;
        border: 1px solid transparent;
        border-radius: 4px;
        color: #856404; 
        background-color: #fff3cd; 
        border-color: #ffeeba; 
        font-weight: bold;
        display: flex;
        justify-content: space-between;
        align-items: flex-start; 
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    .alert-banner button {
        background: transparent;
        color: #856404;
        border: none;
        padding: 5px 10px;
        cursor: pointer;
        font-weight: bold;
        font-size: 1.2em;
        margin-left: 15px;
        line-height: 1;
    }
    .alert-banner button:hover {
        opacity: 0.7;
    }
    .task-list-summary {
        font-size: 0.9em;
        margin-top: 5px;
        white-space: pre-wrap; 
        font-weight: normal; 
    }

    .tomorrow-task {
        font-weight: bold;
        color: orange;
    }

    /* === ESTILOS PARA EL TIME TRACKING ACTIVO (1.2) === */
    @keyframes pulse-active {
        0% { box-shadow: 0 0 5px rgba(56, 142, 60, 0.4); }
        50% { box-shadow: 0 0 10px rgba(56, 142, 60, 0.8); }
        100% { box-shadow: 0 0 5px rgba(56, 142, 60, 0.4); }
    }
    .task-running {
        background-color: #e8f5e9 !important; /* Verde muy claro */
        border: 2px solid #388e3c; /* Borde verde oscuro */
        animation: pulse-active 2s infinite;
    }
    /* ======================================================= */

    /* === MEDIA QUERIES PARA RESPONSIVIDAD (Paso 2) === */
    @media (max-width: 768px) {
        body {
            padding: 0 10px; /* Reduce padding lateral */
        }
        
        /* 1. LAYOUT PRINCIPAL */
        .header-container {
            flex-direction: column; /* Apila el t√≠tulo y el bot√≥n Salir */
            align-items: flex-start;
        }
        .header-container h1 {
            font-size: 1.5em;
        }

        /* 2. TAREAS Y CONTROLES */
        .task-inputs-row {
            flex-direction: column; /* Apila Etiqueta y Fecha */
            gap: 0;
        }
        .task-inputs-row select,
        .task-inputs-row input[type="date"] {
            width: 100%; /* Ocupan todo el ancho */
            margin-bottom: 5px;
        }

        /* 3. BOTONES DE ACCI√ìN */
        .task-buttons {
            flex-direction: column; /* Apila los grupos de botones */
            gap: 15px; 
        }

        /* 4. LISTA DE TAREAS (LI) - Crucial para botones */
        #taskList li > div {
            flex-direction: column; /* Apila el texto y los botones */
            align-items: flex-start;
        }
        #taskList li span {
            margin-bottom: 5px; /* Espacio despu√©s del texto de la tarea */
            display: block;
            width: 100%; /* Asegura que ocupe todo el ancho para el tap */
            cursor: pointer;
        }
        #taskList li > div > div {
            /* Contenedor de botones (Editar, Iniciar/Detener, Eliminar) */
            display: flex;
            flex-wrap: wrap; /* Envuelve los botones si no caben */
            margin-top: 5px;
            width: 100%;
        }
        #taskList li > div > div button {
            margin: 3px 5px 3px 0; /* Espaciado m√°s compacto */
        }
        
        /* 5. CALENDARIO */
        .calendar {
            grid-template-columns: repeat(3, 1fr); /* Muestra 3 columnas en lugar de 5 en m√≥vil */
        }
        .day {
            min-height: 80px; /* Aumenta un poco la altura para el tacto */
            padding: 5px;
        }
        
        /* 6. BANNER DE ALERTA */
        .alert-banner {
            flex-direction: column;
        }
        .alert-banner button {
            align-self: flex-start; /* Alinea el bot√≥n de cerrar */
            margin-left: 0;
            margin-top: 5px;
        }

        /* 7. FILTROS R√ÅPIDOS y ORDENACI√ìN */
        #filterButtons {
            flex-direction: column;
        }
        #filterButtons button {
            width: 100%;
            margin: 3px 0;
        }
        #sortSelector {
            width: 100% !important;
            max-width: none !important;
        }
    }
</style>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script> 
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

</head>
<body>
    <div id="loginSection" class="section" style="max-width: 400px; margin: 50px auto; display: block;">
        <h2>üîí Iniciar Sesi√≥n</h2>
        <p>Usa tu cuenta de Google para acceder a tus tareas sincronizadas.</p>
        
        <button onclick="handleLogin()" class="google-btn">
            üöÄ Iniciar Sesi√≥n con Google
        </button>
        
        <p id="authMessage" style="color:red; margin-top:10px;"></p>
    </div>
    
    <div id="mainContent" style="display: none;">
    
        <div class="header-container">
            <h1>üóìÔ∏è Asistente Diario PRO - PVergaraA</h1>
            <button onclick="logout()" class="logout-btn">
                üö™ Salir
            </button> 
        </div>

        <div id="upcomingTasksBanner" style="display: none;" class="alert-banner">
        </div>
        
        <p id="fecha-hora"></p>

        <div class="section">
            <h2>‚úÖ Tareas</h2>
            <input id="taskInput" placeholder="Escribe una tarea..." type="text"/>
            
            <div class="task-inputs-row">
                <select id="taskTag">
                    <option value="">Etiqueta</option>
                    <option value="Urgente">Urgente</option>
                    <option value="Reuni√≥n">Reuni√≥n</option>
                    <option value="Importante">Importante</option>
                    <option value="Pendiente">Pendiente</option>
                </select>
                <input id="taskDate" type="date"/> 
            </div>
            
            <div class="task-buttons">
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button onclick="exportTasks()">Exportar tareas</button>
                    <button onclick="openBackupWindow()" style="background:#ff9800">üìÇ Respaldo completadas</button> 
                    <button id="deleteBtn" style="background:#d32f2f" onclick="deleteCompletedTasks()">üóëÔ∏è Borrar completadas</button> 
                </div>
                
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button id="addTaskBtn" onclick="addTask()">Agregar tarea</button>
                    <button onclick="startDictation()">üéôÔ∏è Comenzar dictado</button>
                </div>
            </div>
            
            <p id="recordingTimer" style="margin-top: 10px; text-align: right;">‚è±Ô∏è Tiempo de grabaci√≥n: 0 segundos</p>
            <p id="statusMessage" style="color: blue;">Esperando inicio de sesi√≥n...</p>

            <div style="margin-bottom: 15px; display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                <label for="sortSelector" style="font-weight: bold;">Ordenar por:</label>
                <select id="sortSelector" onchange="renderTasks()" style="width: auto; flex-grow: 1; max-width: 300px;">
                    <option value="default">Recientes (Por defecto)</option>
                    <option value="dateAsc">Fecha (Pr√≥xima primero)</option>
                    <option value="dateDesc">Fecha (√öltima primero)</option>
                    <option value="tagPriority">Prioridad (Urgente primero)</option>
                </select>
            </div>
            <div id="filterButtons" style="margin-bottom: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                <button 
                    onclick="filterTasks(null)" 
                    style="background: #007bff; font-weight: bold;"
                    id="filter-all">
                    Mostrar Todas
                </button>
                <button 
                    onclick="filterTasks('Urgente')" 
                    style="background: #dc3545;"
                    id="filter-Urgente">
                    Urgente
                </button>
                <button 
                    onclick="filterTasks('Reuni√≥n')" 
                    style="background: #ffc107; color: #333;"
                    id="filter-Reuni√≥n">
                    Reuni√≥n
                </button>
                <button 
                    onclick="filterTasks('Importante')" 
                    style="background: #28a745;"
                    id="filter-Importante">
                    Importante
                </button>
                <button 
                    onclick="filterTasks('Pendiente')" 
                    style="background: #6c757d;"
                    id="filter-Pendiente">
                    Pendiente
                </button>
            </div>
            <div id="timeSummary" style="padding: 10px; margin-bottom: 15px; background: #e0f7fa; border-radius: 5px; border-left: 5px solid #00bcd4;">
                <p style="margin: 0; font-weight: bold;">
                    Tiempo total de trabajo acumulado: <span id="totalTimeTracked">00:00:00</span>
                </p>
                <p style="margin: 5px 0 0 0; font-size: 0.9em;">
                    Tareas con tiempo registrado: <span id="tasksWithTimeCount">0</span>
                </p>
            </div>
            <ul id="taskList"></ul>
            <p class="stats" id="taskStats"></p>
        </div>

        <div class="section">
            <h2>üìÖ Calendario de tareas</h2>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <button onclick="changeMonth(-1)" style="background: #6c757d;">&lt; Mes Anterior</button>
                <h3 id="currentMonthDisplay" style="margin: 0;"></h3>
                <button onclick="changeMonth(1)" style="background: #6c757d;">Mes Siguiente &gt;</button>
            </div>
            <div class="calendar" id="calendarView"></div>
        </div>
        
        <section id="buscador" class="section">
            <h2>Buscar tareas</h2>
            <div style="display: flex; align-items: center; gap: 10px;">
                <input
                type="text"
                id="searchInput"
                placeholder="Escribe para buscar..."
                style="flex-grow: 1;"
                />
                <button
                id="searchBtn"
                >
                Buscar
                </button>
                <button
                id="clearSearchBtn"
                style="background:#6c757d"
                >
                Limpiar
                </button>
            </div>
            <div id="searchResults" class="mt-4"></div>
        </section>
    
    </div>

<script>
    // ----------------------------------------------------------------------
    // ‚öôÔ∏è CONFIGURACI√ìN E INICIALIZACI√ìN DE FIREBASE (TUS DATOS REALES) ‚öôÔ∏è
    // ----------------------------------------------------------------------
    
    // ** IMPORTANTE: REEMPLAZA ESTO CON TUS CREDENCIALES REALES DE FIREBASE **
    const firebaseConfig = {
        apiKey: "AIzaSyAh1g7i3vI37nSQYkUi1gSKstRvLIrCVOY",
        authDomain: "asistenteweb-d1a36.firebaseapp.com",
        projectId: "asistenteweb-d1a36",
        storageBucket: "asistenteweb-d1a36.firebasestorage.app",
        messagingSenderId: "300972571463",
        appId: "1:300972571463:web:b2259fb2eac4b7bae12a62"
    };

    // Colecci√≥n y Documentos Fijos para todas las tareas
    const COLLECTION_NAME = "users";
    const DOCUMENT_ID = "asistente_master_tasks"; // Tareas principales
    const BACKUP_DOCUMENT_ID = "asistente_backup_tasks"; // Tareas de respaldo

    // Inicializar Firebase con el SDK de compatibilidad (V8 style)
    const app = firebase.initializeApp(firebaseConfig);
    const db = app.firestore(); 
    const auth = app.auth(); 

    // Variables globales
    let tasks = []; // Tareas activas
    let completedTasksBackup = []; // Tareas de respaldo
    let timerUpdateInterval;
    let currentCalendarDate = new Date(); 
    let editingTaskId = null; 
    let currentTagFilter = null; // Filtro de etiqueta actual (null = todas)

    // Elementos DOM
    const loginSection = document.getElementById('loginSection');
    const mainContent = document.getElementById('mainContent');
    const authMessage = document.getElementById('authMessage');
    const statusMessage = document.getElementById('statusMessage');


    // ----------------------------------------------------------------------
    // üíª FUNCIONES AUXILIARES üíª
    // ----------------------------------------------------------------------
    
    // NUEVA FUNCI√ìN: Genera un ID √∫nico para cada tarea
    function generateId() {
        return Date.now().toString(36) + Math.random().toString(36).substring(2);
    }
    
    // NUEVA FUNCI√ìN: Muestra un mensaje temporal de √©xito
    function showSuccessBanner(message) {
        const statusMessage = document.getElementById('statusMessage');
        statusMessage.style.color = 'green';
        statusMessage.innerText = message;
        setTimeout(() => {
            statusMessage.style.color = 'blue';
            statusMessage.innerText = "Cargado desde la nube."; 
        }, 3000);
    }

    function formatDateToDisplay(dateStr) {
        if (!dateStr || dateStr.length !== 10) return 'Sin fecha';
        const parts = dateStr.split('-'); // [YYYY, MM, DD]
        if (parts.length === 3) {
            return `${parts[2]}-${parts[1]}-${parts[0]}`; // DD-MM-YYYY
        }
        return dateStr;
    }

    // NUEVA FUNCI√ìN: Obtiene la fecha de hoy en formato YYYY-MM-DD para el input[type="date"]
    function getTodayDateStrForInput() {
        const today = new Date();
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, '0');
        const day = String(today.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    function formatTime(ms) {
        if (ms === 0 || typeof ms !== 'number') return "00:00:00";
        const totalSeconds = Math.floor(ms / 1000);
        const hours = String(Math.floor(totalSeconds / 3600)).padStart(2, '0');
        const minutes = String(Math.floor((totalSeconds % 3600) / 60)).padStart(2, '0');
        const seconds = String(totalSeconds % 60).padStart(2, '0');
        return `${hours}:${minutes}:${seconds}`;
    }

    function getTomorrowDateStr() {
        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);
        const year = tomorrow.getFullYear();
        const month = String(tomorrow.getMonth() + 1).padStart(2, '0');
        const day = String(tomorrow.getDate()).padStart(2, '0');
        
        return { 
            internal: `${year}-${month}-${day}`, 
            display: `${day}-${month}-${year}` 
        };
    }
    
    function mostrarFechaHora() {
        const ahora = new Date();
        const opcionesFecha = { year: 'numeric', month: '2-digit', day: '2-digit' };
        const fecha = ahora.toLocaleDateString('es-ES', opcionesFecha); // DD/MM/YYYY
        const diaSemanaOpciones = { weekday: 'long' };
        const diaSemana = ahora.toLocaleDateString('es-ES', diaSemanaOpciones);
        const hora = ahora.toLocaleTimeString('es-ES');
        const fechaFormateada = fecha.replace(/\//g, '-'); 
        document.getElementById("fecha-hora").innerHTML = `${diaSemana}, ${fechaFormateada} - ${hora}`;
    }
    mostrarFechaHora();
    setInterval(mostrarFechaHora, 1000);

    // ----------------------------------------------------------------------
    // üîí FUNCIONES DE AUTENTICACI√ìN Y CONTROL DE VISTA üîí
    // ----------------------------------------------------------------------

    function handleLogin() {
        const provider = new firebase.auth.GoogleAuthProvider();
        auth.signInWithPopup(provider)
            .catch((error) => {
                authMessage.innerText = `Error de ingreso con Google: ${error.message}`;
            });
    }

    function logout() {
        auth.signOut().then(() => {
            console.log("Sesi√≥n cerrada.");
        }).catch((error) => {
            console.error("Error al cerrar sesi√≥n: ", error);
        });
    }

    auth.onAuthStateChanged(user => {
        if (user) {
            loginSection.style.display = 'none';
            mainContent.style.display = 'block';
            authMessage.innerText = '';
            loadDataFromCloud(); // Cargar Tareas y Respaldo
            startTimerInterval(); 
        } else {
            loginSection.style.display = 'block'; 
            mainContent.style.display = 'none';
            tasks = [];
            completedTasksBackup = [];
            if (timerUpdateInterval) { 
                clearInterval(timerUpdateInterval); 
            }
            renderTasks();
            renderCalendar();
            document.getElementById('upcomingTasksBanner').style.display='none';
            statusMessage.innerText = "Esperando inicio de sesi√≥n...";
        }
    });

    // ----------------------------------------------------------------------
    // ‚òÅÔ∏è FUNCIONES DE SINCRONIZACI√ìN EN LA NUBE CON FIREBASE ‚òÅÔ∏è
    // ----------------------------------------------------------------------

    async function saveData() {
        if (!auth.currentUser) {
            statusMessage.innerText = "üö® Error: Debes iniciar sesi√≥n para guardar.";
            return;
        }
        
        try {
            statusMessage.innerText = "Guardando...";
            // Guardar Tareas Principales
            await db.collection(COLLECTION_NAME).doc(DOCUMENT_ID).set({ tasks });
            // Guardar Tareas de Respaldo
            await db.collection(COLLECTION_NAME).doc(BACKUP_DOCUMENT_ID).set({ completedTasksBackup });

            console.log("Datos guardados en Firebase.");
            statusMessage.innerText = "Guardado en la nube.";
        } catch (e) {
            console.error("Error al guardar en la nube: ", e);
            statusMessage.innerText = `üö® Error al guardar: ${e.code || e.message}`;
        }
    }

    async function loadDataFromCloud() {
        if (!auth.currentUser) {
            return;
        }
        
        try {
            statusMessage.innerText = "Cargando...";
            
            // Cargar Tareas Principales
            const docSnap = await db.collection(COLLECTION_NAME).doc(DOCUMENT_ID).get();
            tasks = docSnap.exists ? docSnap.data().tasks || [] : []; 

            // Cargar Tareas de Respaldo
            const backupSnap = await db.collection(COLLECTION_NAME).doc(BACKUP_DOCUMENT_ID).get();
            completedTasksBackup = backupSnap.exists ? backupSnap.data().completedTasksBackup || [] : []; 
            
            cleanOldBackups(); // Limpiar respaldos al cargar
            statusMessage.innerText = "Cargado desde la nube.";

        } catch (e) {
            console.error("Error al cargar desde la nube: ", e);
            tasks = [];
            completedTasksBackup = [];
            statusMessage.innerText = `üö® Error de conexi√≥n/reglas de Firebase: ${e.code || e.message}.`;
        }
        
        // Asegurar que las tareas antiguas sin ID lo obtengan
        tasks = tasks.map(t => ({ ...t, id: t.id || generateId() }));

        renderTasks();
        renderCalendar();
        checkUpcomingTasks(); 
        highlightFilterButton(currentTagFilter); 
    }
    
    // ----------------------------------------------------------------------
    // üìä FUNCIONES DE ESTAD√çSTICAS (Paso 3.2) üìä
    // ----------------------------------------------------------------------

    function updateTimeSummary() {
        let totalMs = 0;
        let tasksWithTime = 0;

        tasks.forEach(t => {
            let currentElapsedTime = t.elapsedTime || 0;
            
            // Si la tarea est√° corriendo, a√±ade la diferencia desde startTime hasta ahora
            if (t.startTime !== null) {
                currentElapsedTime += (Date.now() - t.startTime);
            }

            totalMs += currentElapsedTime;
            
            if (currentElapsedTime > 0) {
                tasksWithTime++;
            }
        });

        document.getElementById('totalTimeTracked').innerText = formatTime(totalMs);
        document.getElementById('tasksWithTimeCount').innerText = tasksWithTime;
    }

    // ----------------------------------------------------------------------
    // ‚è±Ô∏è FUNCIONES DEL TIME TRACKER ‚è±Ô∏è
    // ----------------------------------------------------------------------

    // MODIFICADO: Ahora usa taskId para la estabilidad
    function toggleTimer(taskId) {
        const originalIndex = tasks.findIndex(t => t.id === taskId);
        if (originalIndex === -1) return;

        const task = tasks[originalIndex];
        const now = Date.now();

        // Inicializar si no existen
        if (typeof task.elapsedTime === 'undefined') {
             task.elapsedTime = 0;
             task.startTime = null;
        }
        if (typeof task.startTime === 'undefined') task.startTime = null;


        if (task.startTime === null) {
            // INICIAR: Guardar el tiempo actual
            task.startTime = now;
        } else {
            // DETENER: Calcular y acumular el tiempo transcurrido
            const duration = now - task.startTime;
            task.elapsedTime = (task.elapsedTime || 0) + duration;
            task.
